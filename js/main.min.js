var img=new Image,fileName="",downloadSvgBtn=document.getElementById("download-svg-btn"),downloadPngBtn=document.getElementById("download-png-btn"),uploadFile=document.getElementById("upload-file"),rotateImage=document.getElementById("rotate-image"),portraitBtn=document.getElementById("portrait-btn"),squareBtn=document.getElementById("square-btn"),landscapeBtn=document.getElementById("landscape-btn"),resizeableImage=function(E){var g=new Image,n=$(E).get(0),r,t,l,p,w,x,m,q,v=0,u=document.createElement("canvas");
uploadFile.addEventListener("change",function(){var a=document.getElementById("upload-file").files[0],b=new FileReader;a&&(fileName=a.name,b.readAsDataURL(a));b.addEventListener("load",function(){img=new Image;img.src=b.result;img.onload=function(){n.src=b.result;g.src=n.src}},!1)});var y=function(a){a.preventDefault();$(document).off("mouseup touchend",y);$(document).off("mousemove touchmove",z)},A=function(a){r=k.width();t=k.height();l=k.offset().left;p=k.offset().top;w=(a.clientX||a.pageX||a.originalEvent.touches[0].clientX)+
$(window).scrollLeft();x=(a.clientY||a.pageY||a.originalEvent.touches[0].clientY)+$(window).scrollTop();"undefined"!==typeof a.originalEvent.touches&&(m=[],$.each(a.originalEvent.touches,function(a,c){m[a]={};m[a].clientX=0+c.clientX;m[a].clientY=0+c.clientY}));q=a},z=function(a){k.offset();var b=(a.clientX||a.pageX||a.originalEvent.touches[0].clientX)+$(window).scrollLeft();var c=(a.clientY||a.pageY||a.originalEvent.touches[0].clientY)+$(window).scrollTop();if($(q.target).hasClass("resize-handle-se")){var e=
b-l;var d=c-p;var f=l;var h=p}else $(q.target).hasClass("resize-handle-sw")?(e=r-(b-l),d=c-p,f=b,h=p):$(q.target).hasClass("resize-handle-nw")?(e=r-(b-l),d=t-(c-p),f=b,h=c,a.shiftKey&&(h=c-(e/g.width*g.height-d))):$(q.target).hasClass("resize-handle-ne")&&(e=b-l,d=t-(c-p),f=l,h=c,a.shiftKey&&(h=c-(e/g.width*g.height-d)));a.shiftKey&&(d=e/g.width*g.height);60<e&&60<d&&3264>e&&2448>d&&(B(e,d),k.offset({left:f,top:h}))},B=function(a,b){u.width=a;u.height=b;u.getContext("2d").drawImage(g,0,0,a,b);$(n).attr("src",
u.toDataURL("image/png"))},C=function(a){a.preventDefault();$(document).off("mouseup touchend",C);$(document).off("mousemove touchmove",D)},D=function(a){a.preventDefault();a.stopPropagation();var b=a.originalEvent.touches;var c=(a.clientX||a.pageX||b[0].clientX)+$(window).scrollLeft();var e=(a.clientY||a.pageY||b[0].clientY)+$(window).scrollTop();k.offset({left:c-(w-l),top:e-(x-p)});if(m&&1<m.length&&1<b.length){c=r;e=t;var d=m[0].clientX-m[1].clientX,f=m[0].clientY-m[1].clientY,h=Math.sqrt(d*d+
f*f);d=a.originalEvent.touches[0].clientX-b[1].clientX;f=a.originalEvent.touches[0].clientY-b[1].clientY;a=Math.sqrt(d*d+f*f)/h;B(c*a,e*a)}};rotateImage.addEventListener("click",function(){v+=90;var a=g.width,b=g.height,c=document.createElement("canvas");c.id="rotate";var e=c.getContext("2d");c.width=b;c.height=a;e.translate(c.width/2,c.height/2);e.rotate(v*Math.PI/180);e.drawImage(g,-c.height/2,-c.width/2);$(n).attr("src",c.toDataURL("image/png"));g.src=n.src;v=0});portraitBtn.addEventListener("click",
function(){document.getElementById("replaceable").innerHTML="";$("#replaceable").html('<div class="overlay" style="position: absolute; left: 50%; top: 50%; margin-left: -75px; margin-top: -150px; z-index: 999; width: 150px; height: 300px; border: dashed 2px rgba(222,60,80,.9); box-sizing: content-box; pointer-events: none;"> </div>');document.getElementById("replaceable-2").innerHTML="";$("#replaceable-2").html('<img id="magnetific-overlay" src="img/Sample_27x55_Perforated_plain.svg" width="245" height="500">');
document.getElementById("underlay").innerHTML="";$("#underlay").html('<svg id="magnetific-underlay" viewbox="0 0 55 55" width="500" height="500"></svg>')});squareBtn.addEventListener("click",function(){document.getElementById("replaceable").innerHTML="";$("#replaceable").html('<div class="overlay" style="position: absolute; left: 50%; top: 50%; margin-left: -100px; margin-top: -100px; z-index: 999; width: 200px; height: 200px; border: dashed 2px rgba(222,60,80,.9); box-sizing: content-box; pointer-events: none;"> </div>');
document.getElementById("replaceable-2").innerHTML="";$("#replaceable-2").html('<img id="magnetific-overlay" src="img/Sample_55x55_Perforated_plain.svg" width="500" height="500">');document.getElementById("underlay").innerHTML="";$("#underlay").html('<svg id="magnetific-underlay" viewbox="0 0 55 55" width="500" height="500"></svg>')});landscapeBtn.addEventListener("click",function(){document.getElementById("replaceable").innerHTML="";$("#replaceable").html('<div class="overlay" style="position: absolute; left: 50%; top: 50%; margin-left: -150px; margin-top: -75px; z-index: 999; width: 300px; height: 150px; border: dashed 2px rgba(222,60,80,.9); box-sizing: content-box; pointer-events: none;"> </div>');
document.getElementById("replaceable-2").innerHTML="";$("#replaceable-2").html('<img id="magnetific-overlay" src="img/Sample_55x27_Perforated_plain.svg" width="500" height="245">');document.getElementById("underlay").innerHTML="";$("#underlay").html('<svg id="magnetific-underlay" viewbox="0 0 55 55" width="500" height="500"></svg>')});downloadSvgBtn.addEventListener("click",function(){var a=document.getElementById("magnetific-overlay").src,b=new XMLHttpRequest;b.open("GET",a,!1);b.overrideMimeType("image/svg+xml");
b.send("");a=b.responseXML.documentElement.getElementById("layer1");document.getElementById("magnetific-underlay").appendChild(a);b=document.getElementById("magnetific-underlay");a=fileName.substring(0,fileName.length-4)+"-magnetific.svg";b.setAttribute("xmlns","http://www.w3.org/2000/svg");b=new Blob(['<?xml version="1.0" standalone="no"?>\r\n',b.outerHTML],{type:"image/svg+xml;charset=utf-8"});b=URL.createObjectURL(b);var c=document.createElement("a");c.href=b;c.download=a;document.body.appendChild(c);
c.click();document.body.removeChild(c)});downloadPngBtn.addEventListener("click",function(){var a=document.getElementById("magnetific-overlay").src,b=new XMLHttpRequest;b.open("GET",a,!1);b.overrideMimeType("image/svg+xml");b.send("");var c=b.responseXML.documentElement;a=c.getElementById("layer1");b=new XMLHttpRequest;b.open("GET","img/magnetific_watermark.svg",!1);b.overrideMimeType("image/svg+xml");b.send("");b=b.responseXML.documentElement.getElementById("layer1");var e=c.getAttribute("viewBox");
c=e.split(/\s+|,/)[3];e=e.split(/\s+|,/)[2];document.getElementById("magnetific-underlay").appendChild(a);document.getElementById("magnetific-underlay").appendChild(b);a=document.getElementById("magnetific-underlay");var d=fileName.substring(0,fileName.length-4)+"-magnetific.png";var f=document.createElement("canvas");f.id="png";c==e?(f.width=500,f.height=500):c>e?(f.width=245,f.height=500):(f.width=500,f.height=245);var h=f.getContext("2d");a=(new XMLSerializer).serializeToString(a);var g=window.URL||
window.webkitURL||window,k=new Image;a=new Blob([a],{type:"image/svg+xml"});var m=g.createObjectURL(a);k.onload=function(){h.drawImage(k,0,0);g.revokeObjectURL(m);var a=f.toDataURL("image/png");new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});var b=document.createElement("a");b.setAttribute("href",a);b.setAttribute("data-popup","true");b.setAttribute("rel","noopener noreferrer");a=navigator.userAgent||navigator.vendor||window.opera;"unknown"==(/windows phone/i.test(a)?"Windows Phone":
/android/i.test(a)?"Android":navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)?"iOS":"unknown")?b.setAttribute("download",d):(b.setAttribute("target","_blank"),document.getElementById("png-text").innerHTML="",$("#png-text").html('<div><p style="color: rgb(255, 0, 0)">You must allow pop-ups in your browser settings. The Image opens in a new Tab, right-click/touch-and-hold the image and choose save in the menu that appears.</p></div>'));document.body.appendChild(b);b.click();document.body.removeChild(b)};
k.src="";k.src=m});g.src=n.src;$(n).wrap('<div class="resize-container"></div>').before('<span class="resize-handle resize-handle-nw"></span>').before('<span class="resize-handle resize-handle-ne"></span>').after('<span class="resize-handle resize-handle-se"></span>').after('<span class="resize-handle resize-handle-sw"></span>');var k=$(n).parent(".resize-container");k.on("mousedown touchstart",".resize-handle",function(a){a.preventDefault();a.stopPropagation();A(a);$(document).on("mousemove touchmove",
z);$(document).on("mouseup touchend",y)});k.on("mousedown touchstart","img",function(a){a.preventDefault();a.stopPropagation();A(a);$(document).on("mousemove touchmove",D);$(document).on("mouseup touchend",C)});$(".js-crop").on("click",function(){var a=$(".overlay").offset().left-k.offset().left,b=$(".overlay").offset().top-k.offset().top,c=$(".overlay").width(),e=$(".overlay").height();var d=document.createElement("canvas");d.width=c;d.height=e;if(d.width>d.height){var f=55;var h=27}d.width<d.height&&
(f=27,h=55);d.width==d.height&&(h=f=55);d.width=f;d.height=h;d.getContext("2d").drawImage(n,a,b,c,e,0,0,f,h);d=d.getContext("2d").getImageData(0,0,f,h);$("#magnetific-underlay").empty();a=document.getElementById("magnetific-underlay");for(b=0;b<f;b++)for(c=0;c<h;c++){e=d.data[4*c*d.width+4*b];var g=d.data[4*c*d.width+4*b+1],m=d.data[4*c*d.width+4*b+2],l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttributeNS(null,"y",c);l.setAttributeNS(null,"x",b);l.setAttributeNS(null,"width",
1);l.setAttributeNS(null,"height",1);l.setAttributeNS(null,"fill","rgb("+e+","+g+","+m+")");a.appendChild(l)}})};resizeableImage($(".resize-image"));